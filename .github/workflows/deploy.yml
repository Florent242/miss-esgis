name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            echo "ðŸš€ DÃ©ploiement en cours..."

            # Aller dans le rÃ©pertoire du projet
            cd ${{ secrets.DEPLOY_PATH }}

            # Mettre l'application en mode maintenance
            php artisan down || true

            # RÃ©cupÃ©rer les derniÃ¨res modifications
            echo "ðŸ“¥ RÃ©cupÃ©ration des modifications..."
            git pull origin main

            # Installer/mettre Ã  jour les dÃ©pendances Composer
            echo "ðŸ“¦ Installation des dÃ©pendances PHP..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            # Installer/mettre Ã  jour les dÃ©pendances NPM et builder les assets
            echo "ðŸŽ¨ Build des assets..."
            npm install
            npm run build

            # Nettoyer et optimiser le cache
            echo "ðŸ§¹ Nettoyage du cache..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            # Optimiser pour la production
            echo "âš¡ Optimisation..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # CrÃ©er le lien symbolique pour le storage (si non existant)
            php artisan storage:link || true

            # Permissions
            echo "Configuration des permissions..."
            sudo chown -R ${{ secrets.SSH_USER }}:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # RedÃ©marrer les services
            echo "RedÃ©marrage des services..."
            php artisan queue:restart || true
            sudo systemctl reload php8.1-fpm
            sudo systemctl reload nginx

            # Remettre l'application en ligne
            php artisan up

            echo "DÃ©ploiement terminÃ© avec succÃ¨s !"
          EOF

      - name: Deployment notification
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "DÃ©ploiement rÃ©ussi sur le serveur"
          else
            echo "Ã‰chec du dÃ©ploiement"
          fi
