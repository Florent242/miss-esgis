#!/bin/bash

# Post-receive hook pour d√©ploiement automatique
# √Ä placer sur le serveur dans : /path/to/repo.git/hooks/post-receive

while read oldrev newrev ref
do
    branch=$(git rev-parse --symbolic --abbrev-ref $ref)
    
    if [ "$branch" == "main" ] || [ "$branch" == "master" ]; then
        echo "üöÄ D√©ploiement de la branche $branch..."
        
        # Chemin vers votre application
        APP_DIR="/var/www/reine-esgis.com"
        
        cd $APP_DIR
        
        # Pull des changements
        git fetch --all
        git reset --hard origin/$branch
        
        # V√©rifier si des fichiers de sandbox ont √©t√© modifi√©s
        if git diff --name-only $oldrev $newrev | grep -E "(SandboxPayment|MoMoPayment|payment-modal|deploy_sandbox)" > /dev/null; then
            echo "üì¶ Mise √† jour de la sandbox d√©tect√©e"
            
            # Ex√©cuter le script de d√©ploiement seulement si configur√©
            if [ -f "scripts/deploy_sandbox.sh" ] && grep -q "MTN_MOMO_API_USER" .env; then
                bash scripts/deploy_sandbox.sh
            fi
        fi
        
        # Red√©marrage services (optionnel)
        # sudo systemctl reload php8.2-fpm
        # sudo systemctl reload nginx
        
        echo "‚úÖ D√©ploiement termin√©"
    fi
done
