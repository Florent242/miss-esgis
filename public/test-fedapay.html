<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test FedaPay - Miss ESGIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold mb-6 text-center">Test Paiement FedaPay</h1>
            
            <form id="paymentForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Candidate</label>
                    <select id="miss_id" class="w-full border rounded px-3 py-2" required>
                        <option value="1">Candidate #1</option>
                        <option value="2">Candidate #2</option>
                        <option value="3">Candidate #3</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Numéro de téléphone</label>
                    <input type="tel" id="phone_number" 
                           class="w-full border rounded px-3 py-2" 
                           placeholder="97123456"
                           value="97000001"
                           required>
                    <small class="text-gray-500">En sandbox: 97000001 (test MTN)</small>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Email (optionnel)</label>
                    <input type="email" id="email" 
                           class="w-full border rounded px-3 py-2" 
                           placeholder="voteur@example.com">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Nombre de votes</label>
                    <input type="number" id="vote_count" 
                           class="w-full border rounded px-3 py-2" 
                           min="1" max="100" value="1" required>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Montant total</label>
                    <input type="text" id="amount" 
                           class="w-full border rounded px-3 py-2 bg-gray-100" 
                           value="100" readonly>
                    <small class="text-gray-500">100 FCFA par vote</small>
                </div>

                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">
                    Payer maintenant
                </button>
            </form>

            <div id="result" class="mt-4 hidden"></div>

            <div class="mt-6 p-4 bg-yellow-50 rounded border border-yellow-200">
                <h3 class="font-bold text-yellow-800 mb-2">Mode Sandbox</h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>✅ MTN Test: 97000001 (PIN: 0000)</li>
                    <li>✅ Moov Test: 96000001 (PIN: 0000)</li>
                    <li>✅ Carte Test: 4242 4242 4242 4242</li>
                </ul>
            </div>

            <div class="mt-4 text-center">
                <button onclick="checkStatus()" 
                        class="text-blue-600 underline text-sm">
                    Vérifier le statut du dernier paiement
                </button>
            </div>
        </div>
    </div>

    <script>
        // Calculer le montant automatiquement
        document.getElementById('vote_count').addEventListener('input', function() {
            const voteCount = parseInt(this.value) || 1;
            const amount = voteCount * 100;
            document.getElementById('amount').value = amount;
        });

        // Gérer le formulaire
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="text-blue-600">Initialisation du paiement...</p>';
            resultDiv.classList.remove('hidden');

            const data = {
                miss_id: parseInt(document.getElementById('miss_id').value),
                phone_number: document.getElementById('phone_number').value,
                email: document.getElementById('email').value || null,
                vote_count: parseInt(document.getElementById('vote_count').value),
                amount: parseInt(document.getElementById('amount').value)
            };

            try {
                const response = await fetch('/api/fedapay/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-green-100 border border-green-400 rounded">
                            <p class="text-green-800 font-bold">✅ Paiement initialisé !</p>
                            <p class="text-sm text-green-700 mt-2">Référence: ${result.reference}</p>
                            <p class="text-sm text-green-700">Redirection vers FedaPay...</p>
                        </div>
                    `;

                    // Sauvegarder la référence
                    localStorage.setItem('last_payment_ref', result.reference);

                    // Rediriger vers la page de paiement FedaPay
                    setTimeout(() => {
                        window.location.href = result.payment_url;
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-red-100 border border-red-400 rounded">
                            <p class="text-red-800 font-bold">❌ Erreur</p>
                            <p class="text-sm text-red-700">${result.error || 'Erreur inconnue'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 rounded">
                        <p class="text-red-800 font-bold">❌ Erreur réseau</p>
                        <p class="text-sm text-red-700">${error.message}</p>
                    </div>
                `;
            }
        });

        // Vérifier le statut
        async function checkStatus() {
            const reference = localStorage.getItem('last_payment_ref');
            
            if (!reference) {
                alert('Aucun paiement trouvé');
                return;
            }

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="text-blue-600">Vérification...</p>';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/fedapay/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ reference })
                });

                const result = await response.json();

                const statusColors = {
                    pending: 'yellow',
                    completed: 'green',
                    failed: 'red'
                };

                const color = statusColors[result.status] || 'gray';

                resultDiv.innerHTML = `
                    <div class="p-4 bg-${color}-100 border border-${color}-400 rounded">
                        <p class="text-${color}-800 font-bold">Statut: ${result.status}</p>
                        <p class="text-sm text-${color}-700">Référence: ${result.reference}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 rounded">
                        <p class="text-red-800">Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
